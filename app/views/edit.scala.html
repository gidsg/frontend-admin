@(config: String)

@main("Front editor", isAuthed = true) {
    <script>
        var frontConfig = @Html(config)
    </script>

    <form id="network-front">
        <!-- <fieldset class="trailblocks">
            <legend>UK Edition</legend>
            <label for="tag">Tag</label>
            <input type="text" class="typeahead" data-provide="typeahead" data-items="4" data-source='["abc", "asd", "asdf"]' name="tag" />
            <input type="hidden" name="edition" value="uk" />
        <fieldset> -->
        <fieldset class="trailblocks">
            <legend>US Edition</legend>
            <label for="tag">Tag</label>
            <input type="text" class="typeahead" name="tag" autocomplete="off" />
            <input type="hidden" name="edition" value="us" />
        </fieldset>
        <div id="autocomplete"></div>
        <input type="submit" value="Save" />
    </form>


    <script>
        curl(['controllers/trailblocks', 'Config', 'Common', 'AutoComplete', 'TagSearch']).then(
                function(Trailblocks, Config, Common, AutoComplete, TagSearch) {
            
            new Trailblocks({el: $("body")})

            new TagSearch.init( { apiEndPoint: 'http://content.guardianapis.com/tags', config: Config } );

            // http://stackoverflow.com/questions/1909441/jquery-keyup-delay
            var delay = (function(){
                 var timer = 0;
                 return function(callback, ms){
                    clearTimeout (timer);
                    timer = setTimeout(callback, ms);
                    };
                 })();

            $('.typeahead').keyup(function (e) {
                
                Common.mediator.emitEvent('ui:autocomplete:keydown', [this.value]);
                
                var that = this;

                if (this.value.length <= 3) {
                    return false; 
                }
                
                delay(function () {
                    Common.mediator.emitEvent('modules:oncomplete', [that.value]);
                }, 1000)
            });

            Common.mediator.addListener('modules:autocomplete:selected', function (tag) {
                $('.typeahead').val(tag);
            });
            
            Common.mediator.addListener('modules:tagsearch:success', function (results) {
                console.log('yay!', results);
            });

        });

    </script>

}
