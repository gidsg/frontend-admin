@(config: String, env: String)

@main("Status", env, isAuthed = true) {

    <script src="@routes.Assets.at("javascripts/vendor/zepto.min.js")"></script>
    <script src="@routes.Assets.at("javascripts/vendor/d3.v3.min.js")"></script>
    <script src="@routes.Assets.at("javascripts/vendor/rickshaw.min.js")"></script>
    
    <style>
        * {
            font-family: Helvetica, sans-serif; 
        }

        #last-refresh {
            background-color: #ffd;
            padding: 0.1em 0.5em;          
            display: inline;
            margin-left: -0.5em;
        }

        svg {
            display: block;
            margin: 5px;
        }

        svg path { stroke-width: 1; }
        header { background-color: #214583; }

        /* */
        #build-status {
            width: 100%;
            overflow: auto;
        }
        #build-status div {  width: 8.3333%; min-height: 30px; float: left; }
        .red-build { background-color: #cf171f; }
        .green-build { background-color: #d0dab4; }
        
        body { margin: 0 auto; width: 90%; padding: 40px 0 50% 0; }
        h2 { font-size: 15px; clear: both; line-height: 20px; font-weight: normal; margin-top: 20px; }

        @@media (max-width: 600px){
            .row-fluid .span6, .row-fluid .span3 {
                width: 100%;
                margin-left: 0px;
            } 
        }

    </style>

    <div class="alert alert-info">
        <strong>Note!</strong> This application will only work if you are on the guardian internal network and signed in to <a
            href="dashboard.ophan.co.uk">Ophan</a> and <a href="http://riffraff.gudev.gnl">RiffRaff</a>.
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <div class="row-fluid">
          <div class="span6">
            <div class="row-fluid">
              <div class="span10" id="col2">
                <h2>Combined server-side errors</h2>
                <div id="server-errors"></div>
                <h2>Combined client-side errors</h2>
                <div id="client-errors"></div>
                <h2>Performance</h2>
                <div id="ophan-perf"></div>
                <h2>Page views - <span class="badge" id="ophan-views-val"></span></h2> 
                <div id="ophan-views"></div>
              </div>
              <div class="span2">
              </div>
            </div>
          </div>
          <div class="span6" id="col1">
            <h2>Request duration - all applications</h2>
            <div id="request-duration"></div>
          </div>
        </div>
      </div>
    </div>




    <script>
        curl(['graphite'])
            .then(function(graphite) {

                var lastRefresh = new Date();

                // convert Graphite datapoints to something Rickshaw understands  
                var graphiteJsonToRickshaw = function(d) {
                    return d.map( function(i) {
                        return { name: i.target, data: i.datapoints.map(function(dd, i) {
                            return { x: dd[1], y: dd[0] }
                            })
                        }
                    })
                };
         
                // factory for Richshaw ajax requests
                Rickshaw.Graph.JSONP.Static = Rickshaw.Class.create( Rickshaw.Graph.JSONP, {

                    request: function() {
                        $.ajax( {
                            url: this.dataURL,
                            success: this.success.bind(this),
                            error: this.error.bind(this),
                            dataType: 'jsonp',
                            timeout: 5000,
                            jsonpCallback: 'callback'
                        } );
                    }
                 });

                // ** request duration 
                var g = new graphite.client({ host: 'http://graphite.guprod.gnl/render', from: '-1hours' });
                g.targets = [
                        'ganglia.GU-PROD-Frontend.frontend-article_*.*.gu_request_duration_performance_time-frontend-article.sum',
                        'ganglia.GU-PROD-Frontend.frontend-front_*.*.gu_request_duration_performance_time-frontend-front.sum',
                        'ganglia.GU-PROD-Frontend.frontend-section_*.*.gu_request_duration_performance_time-frontend-section.sum',
                        'ganglia.GU-PROD-Frontend.frontend-tag_*.*.gu_request_duration_performance_time-frontend-tag.sum',
                        'ganglia.GU-PROD-Frontend.frontend-gallery_*.*.gu_request_duration_performance_time-frontend-gallery.sum',
                        'ganglia.GU-PROD-Frontend.frontend-football_*.*.gu_request_duration_performance_time-frontend-football.sum',
                        'ganglia.GU-PROD-Frontend.frontend-video_*.*.gu_request_duration_performance_time-frontend-video.sum'
                    ].map(function(tag){
                        return new graphite.target(tag)
                                     .exclude('__SummaryInfo__')
                                     .averageSeries()
                                     .alias(/frontend-([^_]+)/.exec(tag)[1])
                                     .toQueryString()
                    })

                // draw a graph 
                var jsonpGraph = new Rickshaw.Graph.JSONP.Static( {

                    element: document.getElementById("request-duration"),
                    width: window.getComputedStyle(document.getElementById('col1'),null).getPropertyValue("width") * 0.9,
                    height: 75 * 4, 
                    renderer: 'line',
                    dataURL: g.toUrl(),
                    onData: graphiteJsonToRickshaw,
                    series: [
                        {
                            name: 'article',
                            color: '#666',
                        }, {
                            name: 'front',
                            color: '#888',
                        }, {
                            name: 'section',
                            color: '#aaa'
                        }, {
                            name: 'tag',
                            color: '#bbb'
                        }, {
                            name: 'gallery',
                            color: '#ccc'
                        }, {
                            name: 'football',
                            color: '#999'
                        }, {
                            name: 'video',
                            color: '#555'
                        }
                    ]
                } );
                
                // ** server errors 
                var e = new graphite.client({ host: 'http://graphite.guprod.gnl/render' });
                e.targets = [
                    'ganglia.GU-PROD-Frontend.frontend-*_*.*.gu_50x_error_request_status_rate-frontend-*.sum'
                    ].map(function(tag){
                        return new graphite.target(tag)
                                     .exclude('__SummaryInfo__')
                                     .averageSeries()
                                     .alias(/gu_([^_]+)/.exec(tag)[1])
                                     .toQueryString()
                    })

                 var jsonpServerErrorsGraph = new Rickshaw.Graph.JSONP.Static( {

                    element: document.getElementById("server-errors"),
                    width: window.getComputedStyle(document.getElementById('col2'),null).getPropertyValue("width") * 0.9,
                    height: 50,
                    renderer: 'line',
                    dataURL: e.toUrl(),
                    onData: graphiteJsonToRickshaw,
                    series: [
                        {
                            name: '50x',
                            color: '#cf171f'
                        }
                    ]
                } );
                
                // ** client errors 
                var e = new graphite.client({ host: 'http://graphite.guprod.gnl/render' });
                e.targets = [
                    'ganglia.GU-PROD-Frontend.frontend-diagnostics_*.*.gu_px_gif_diagnostics_rate-frontend-diagnostics.sum',
                    ].map(function(tag){
                        return new graphite.target(tag)
                                     .exclude('__SummaryInfo__')
                                     .averageSeries()
                                     .alias(/gu_px_gif_([^_]+)/.exec(tag)[1])
                                     .toQueryString()
                    })

                 var jsonpClientErrorsGraph = new Rickshaw.Graph.JSONP.Static( {

                    element: document.getElementById("client-errors"),
                    width: window.getComputedStyle(document.getElementById('col2'),null).getPropertyValue("width") * 0.9,
                    height: 50,
                    renderer: 'line',
                    dataURL: e.toUrl(),
                    onData: graphiteJsonToRickshaw,
                    series: [
                        {
                            name: 'diagnostics',
                            color: '#cf171f'
                        }
                    ]
                } );

                /** views */
                var ophanViews = new Rickshaw.Graph.JSONP.Static( {

                    element: document.getElementById("ophan-views"),
                    width: window.getComputedStyle(document.getElementById('col2'),null).getPropertyValue("width") * 0.9,
                    height: 50,
                    renderer: 'line',
                    dataURL: 'http://dashboard.ophan.co.uk/perf/pageviews/data?host=m.guardian.co.uk&host=m.guardiannews.com&hours=1&callback=?',
                    onData: function(d) {
                                var today = d.filter(
                                    function(i) { return i.name === "Today" })
                                document.getElementById('ophan-views-val').innerHTML = today[0].data[0].y + ' requests p/min'
                                return today;
                            },
                    series: [
                        {
                            name: 'Today',
                            color: 'green'
                        }
                    ]
                } );
                
                /** perf */
                var ophanPerf = new Rickshaw.Graph.JSONP.Static( {

                    element: document.getElementById("ophan-perf"),
                    width: window.getComputedStyle(document.getElementById('col2'),null).getPropertyValue("width") * 0.9,
                    height: 50,
                    renderer: 'line',
                    dataURL: 'http://dashboard.ophan.co.uk/perf/timings/data?hours=1&host=m.guardian.co.uk&host=m.guardiannews.com&callback=?', 
                    onData: function(d) {
                                return d.filter(
                                    function(i) { return i.name !== "Load Event" })
                            },
                    series: [
                        {
                            name: 'DNS',
                            color: '#a2d00b'
                        },
                        {
                            name: 'First Byte',
                            color: '#b5e80c'
                        },
                        {
                            name: 'DomContentReady Event',
                            color: '#7c9f08'
                        }
                    ]
                } );

                // TODO https://dev.riffraff.gudev.gnl/api/history?project=frontend&stage=PROD&key=oFsACDUt5L2HfLgfdSW2Xf1nbOKHLN5A
                /*
                   stage: "PROD",
                       projectName: "frontend::router",
                       build: "331",
                       deployer: "Patrick Hamann",
                       status: "Completed",
                    taskType: "Deploy",
                    time: 1363971152706
                */

                // polling
                    
                window.setInterval(function() {
                    ophanViews.request();
                    ophanPerf.request();
                }, 5000) 

                window.setInterval(function() {

                    // refresh graph data 
                    jsonpGraph.request();
                    jsonpServerErrorsGraph.request();
                    jsonpClientErrorsGraph.request();
                    
                    // refresh last-update attempt timestamp
                    document.querySelector('#last-refresh').innerHTML = Math.floor((new Date() - lastRefresh) / 1000) + ' seconds ago, ' + new Date();
                    lastRefresh = new Date();

                }, 30000);

            }, function() { 
                console.error('curl.js failed to load')
            });
    </script>

}
