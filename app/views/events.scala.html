@(identity: String, env: String)

@main("Events editor", env, isAuthed = true, identity) {

<div class="storify row-fluid">
  <div class="storify-articles span4">
    <form class="form-inline muted" onsubmit="return false">
        <h3>Articles</h3>
        <input type="text" placeholder="Search" 
            data-bind='event: {keyup: articles.articleSearch, mousedown: articles.articleSearch, afterpaste: articles.articleSearch}, value:
            articles.articleTerm, valueUpdate: ["afterkeydown", "afterpaste"]'/>
        <!--
        <select data-bind='
            value: articles.sectionTerm,
            options: sections,
            optionsText: "webTitle",
            optionsValue: "id",
            valueUpdate: "afterkeydown",
            optionsCaption: "Section",
            event: {change: articles.articleSearch}
            '></select> -->
        <label class="checkbox">
            <!--<input id="tone-news" type="checkbox" value="news" 
                data-bind="checked: articles.toneNews, event: {click: articles.articleSearch}"/>
                tone/news-->
        </label>
    </form>

    <div class="articles scrollable" data-bind='foreach: articles.articles'>
        <div class="article" draggable="true" data-bind="makeDraggable: true">
            <a class="article-title" target="_blank"
                data-bind="html: webTitle, attr: {href: mDot}"></a>
            <div class="article-date"  data-bind="text: _humanDate"></div>
        </div>
    </div>
  </div>

  <div class="storify-events span8">
    <form class="form-inline" onsubmit="return false">
        <h3>Events</h3>
        <p>
        <small>
        Events are things that are happening in the <b>real world</b>.
        Try and phrase events you create in the form of a factual statement -  Eg, 'Chris Huhne resigns as MP', 'Michael Gove gives speech about Ebbac reforms'.
        </small>
        </p>

        <input type="text" placeholder="Search" data-bind='
            event: {keyup: events.pruneTrees}, 
            value: events.pruneTerm, 
            valueUpdate: "afterkeydown",
            visible: !$root.events.selected()
        '/>

        <button class="btn btn-mini" data-bind="
            click: events.clearSelected,
            visible: $root.events.selected()
        ">Show all events</button>

        <button class="btn btn-mini create btn-success" data-bind="
            click: events.createEvent,
            visible: !$root.events.selected()
        ">Create an event</button>

        <button class="btn btn-mini create btn-success" data-bind="
            click: $root.events.createEventFollowOn,
            visible: $root.events.selected() && !$root.events.selected()._editing()
        ">Create a FOLLOW-ON event</button>

    </form>
    <div data-bind="text: events.length() === 0 ? 'Loading...' : ''"></div>
    <div class="events scrollable" data-bind="template: {name: 'event_template', foreach: events.trees}"></div>
  </div>

</div>

<script type="text/html" id="event_template">
  <!-- ko if: !_hidden() -->
    <div data-bind="css: {'event-wrapper': !$root.events.selected()}">
            
        <div class="event" data-bind="
            makeDropabble: !_editing(), 
            if: !$root.events.selected() || $root.events.selected() === $data
        ">

            <div class="event-header" data-bind="if: !_editing()">
                <i data-bind="
                    click: bump,
                    css: {
                        'icon-star-empty': importance() <= 50,
                        'icon-star': importance() > 50
                    }
                "></i>
                <span class="event-title" data-bind="
                    text: title().length > 0 ? title : 'New Event',
                    event: {click: $root.events.setSelected},
                "></span>
                <span class="count" 
                    data-bind="text: content().length + ' article' + (content().length !== 1 ? 's' : '')"></span>
                <span class="event-date" data-bind="text: _humanDate"></span>
            </div>

            <div data-bind="if: $root.events.selected() === $data">
                <div class="event-detail" data-bind="ifnot: _editing()">
                    <div class="event-articles" data-bind="foreach: content">
                        <!-- ko if: webTitle -->
                        <div class="article">
                            
                            <button type="button" class="close"
                                data-bind='click: $parent.removeArticle' class="close">Ã—</button>

                            <div class="article-star" data-bind="
                                click: $parent.bumpContent,
                                css: {
                                    'icon-star-empty': importance() <= 50,
                                    'icon-star': importance() > 50
                                }
                            "></div>
                        
                            <span title="color: dark = serious, light = entertaining" data-bind="
                                css: {
                                      'color-light': colour() <= 2,
                                      'color-dark': colour() > 2
                                     },
                                click: $parent.setColour">&nbsp;</span>

                            <a class="article-title" target="_blank"
                                data-bind="text: webTitle, attr: {href: mDot}"></a>
                            <div class="article-date"  data-bind="text: _humanDate"></div>
                        </div>
                        <!-- /ko -->
                    </div>
                    <!-- ko if: content().length === 0 -->
                    <p class="alert">Drag articles here</p>
                    <!-- /ko -->
                    <div class="event-meta">
                        <div>
                            <span class="muted">Explainer:</span> 
                            <span data-bind="html: explainer() ? explainer : '(none)'"></span>
                        </div>
                        <div>
                            <span class="muted">Event date:</span> 
                            <span data-bind="text: _prettyDate"></span>
                            <span data-bind="text: _prettyTime"></span>                        
                        </div>
                        <div>
                            <span class="muted">Created by:</span> 
                            <span data-bind="text: createdBy"></span>
                        </div>
                        <div>
                            <span class="muted">Updated by</span> 
                            <span data-bind="text: lastModifiedBy"></span>
                        </div>
                    </div>
                    
                    <!-- Agents -->


                    <h3>
                        Agents
                        <span class="count" data-bind="text: agents().length + ' agent' + (agents().length !== 1 ? 's' : '')"></span>
                    </h3>
                    <p>
                        <small>
                            Agents are <strong>people</strong> and <strong>organisations</strong> that appear in the story. <em>Nb. We don't have an
                                editing interface for agents yet.</em>
                        </small>     
                    </p>
                    <div data-bind="foreach: agents">
                        <dl>
                            <dt>
                                <p><span data-bind="text: name"></span></p>
                            </dt>
                            <dd>
                                <p data-bind="text: explainer"></p>
                                <!-- ko if: $data.sameAs().length > 0 -->
                                <p>
                                    <small>
                                        seeAlso - The property seeAlso specifies a resource that might provide additional information about the
                                        subject resource.
                                        <!-- http://www.w3.org/TR/2000/CR-rdf-schema-20000327/#s2.3.4 -->
                                    </small>
                                </p>
                                    <ul data-bind="foreach: $data.sameAs">
                                        <li><a data-bind="attr: {href: $data}, text: $data"></a></li>
                                    </ul>
                                <!-- /ko -->
                            </dd>
                         </dl>
                    </div>
                    
                    <button class="event-form-toggler btn btn-mini" data-bind="event: {click: toggleEditing}" href="javascript:void(0)">Edit</button>
                    <button class="btn btn-danger btn-mini" type="submit" value="delete"
                         data-bind="click: $root.events.deleteEvent, visible: !_tentative()"
                     >Delete event</button>

                  </div>

                <form class="event-form" data-bind="if: _editing(), submit: save">
                  
                    <label>Title (what happend, is happening, or might happen?)</label>
                    <input type="text" placeholder="e.g. 'Helicopter crash"
                        data-bind='value: title, valueUpdate: "afterkeydown"' />

                    <label data-bind='visible: !_editParent()'>
                        <span data-bind="
                            text: _parentId() ? 'Follows: ' + _parentTitle() : 'This has no previous event'
                        "></span>
                        <small class="muted">[<a data-bind="click: toggleEditParent">change</a>]</small>
                    </label>

                    <label data-bind='if: _editParent()'>
                        Follows:
                        <select data-bind='
                            value: _parentId, 
                            options: $root.events.previous(),
                            optionsText: "title",
                            optionsValue: "id",
                            optionsCaption: "(select a previous event)"
                        '></select>
                    </label>

                    <label>Explainer</label>
                    <textarea class="event-explainer"
                        data-bind='value: explainer, valueUpdate: "afterkeydown"'>
                    </textarea>

                    <label>When</label>
                    <input type="date"
                        data-bind='value: _prettyDate, valueUpdate: "afterkeydown"' />

                    <label>Time</label>
                    <input type="time"
                        data-bind='value: _prettyTime, valueUpdate: "afterkeydown"' />

                    <div>
                        <button class="btn btn-success btn-mini" type="submit" data-bind="enable: _isValid">Save event</button>
                        <button class="btn btn-mini" type="submit" value="cancel"
                            data-bind="click: $root.events.cancelEditing" 
                        >Cancel</button>
                        <button class="btn btn-danger btn-mini" type="submit" value="delete"
                            data-bind="click: $root.events.deleteEvent, visible: !_tentative()"
                        >Delete event</button>
                    </div>
                </form>

            </div>
        </div>
        <div data-bind="
            css: {
                'event-children': !$root.events.selected()
            },
            template: {
                name: 'event_template',
                foreach: _children,
            }
        ">
        </div>
    </div>
  <!-- /ko -->
</script>

<script src="@routes.Assets.at("javascripts/eventsEditor.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/vendor/humanized_time_span.js")" type="text/javascript"></script>


}
