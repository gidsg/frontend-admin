@(identity: String, env: String)

@main("Story editor", env, isAuthed = true, identity) {

<div class="storify row-fluid">
  <div class="storify-articles span4">
    <form class="form-inline muted" onsubmit="return false">
        <h3>Articles</h3>
        <input type="text" placeholder="Search" 
            data-bind='event: {keyup: articles.search, mousedown: articles.articleSearch, afterpaste: articles.articleSearch}, value:
            articles.term, valueUpdate: ["afterkeydown", "afterpaste"]'/>
        <!--
        <select data-bind='
            value: articles.term,
            options: sections,
            optionsText: "webTitle",
            optionsValue: "id",
            valueUpdate: "afterkeydown",
            optionsCaption: "Section",
            event: {change: articles.search}
            '></select> -->
        <label class="checkbox">
            <!--<input id="tone-news" type="checkbox" value="news" 
                data-bind="checked: articles.toneNews, event: {click: articles.search}"/>
                tone/news-->
        </label>
    </form>

    <div class="articles scrollable" data-bind='foreach: articles.articles'>
        <div class="article" draggable="true" data-bind="makeDraggable: true">
            <a class="article-title" target="_blank"
                data-bind="html: webTitle, attr: {href: _mDot}"></a>
            <div class="article-meta"  data-bind="text: _humanDate"></div>
        </div>
    </div>
  </div>

  <div class="storify-events span8">
    <!-- ko if: !$root.stories.selected() -->
        <h3>Stories</h3>
        <button class="btn btn-mini create btn-success" data-bind="
            event: {click: stories.createStory}
        ">Start a Story</button>
        <div class="stories" data-bind="
            template: {name: 'story_closed_template', foreach: stories.stories}
        "></div>
        <div data-bind="text: stories.length() === 0 ? 'Loading stories...' : ''"></div>
    <!-- /ko -->

    <!-- ko with: $root.stories.selected() -->
        <div class="stories" data-bind="template: {name: 'story_open_template'}"></div>
    <!-- /ko -->

  </div>
</div>

<!-- template: story in closed state -->
<script type="text/html" id="story_closed_template">
    <div class="story-wrap">
        <div class="story-title" data-bind="
            text: title().length > 0 ? title : '(Un-titled story)',
            event: {click: $root.stories.setSelected}
        "></div>
    </div>
</script>

<!-- template: story in open state -->
<script type="text/html" id="story_open_template">
    <div class="story-wrap">

        <button class="btn btn-mini" data-bind="
            event: {click: $root.stories.clearSelected},
            disable: $root.pendingSave()
        ">&laquo; Back to Stories</button>

        <span class="muted" data-bind="visible: $root.pendingSave()">saving...</span>

        <h3 class="story-title" contentEditable="true" data-bind="textEditable: title"></h3>

        <p>
            <div class="muted">Chapters:</div>
            <div class="events" data-bind="template: {name: 'event_template', foreach: events}"></div>
            <a data-bind="
                event: {click: createEvent},
                text: length() === 0 ? 'add the first chapter' : 'add another chapter'
            "></a>
        </p>

        <p>
            <div class="muted">Overall Synopsis:</div>
            <div contentEditable="true" data-bind="htmlEditable: explainer"></div>
        </p>

        <p>
            <button class="btn btn-mini" data-bind="
                event: {click: $root.stories.deleteSelected}
            ">Delete this story</button>
        </p>
    </div>
</script>

<!-- template: event -->
<script type="text/html" id="event_template">
    <div class="event" data-bind="makeDropabble: true, css: {well: $parent._selected() === $data}">
        <i data-bind="
            click: bump,
            css: {
                'icon-star-empty': importance() <= 50,
                'icon-star': importance() > 50
            }
        "></i>

        <!-- An UNselected event: -->
        <!-- ko if: $parent._selected() !== $data -->
            <span class="event-title" data-bind="
                text: title().length > 0 ? title : '(untitled chapter)',
                event: {click: $parent.setSelected}
            "></span>
            <span class="count" data-bind="
                text: content().length + ' article' + (content().length !== 1 ? 's' : '')
            "></span>
            <span class="event-meta" data-bind="text: _humanDate"></span>
        <!-- /ko -->

        <!-- An SELCTED event: -->
        <!-- ko if: $parent._selected() === $data -->
            <span class="event-title" contentEditable="true" data-bind="
                textEditable: title().length > 0 ? title : '(untitled chapter)'
            "></span>
            <span class="muted">
                | <a data-bind="click: $parent.clearSelected">collapse</a>
            </span>

            <div class="event-innards">

                <p>
                    <div class="muted">Articles</div>
                    <div class="event-articles" data-bind="
                        template: {name: 'event_article_template', foreach: content}
                    "></div>
                    <!-- ko if: content().length === 0 -->
                        <div>drag articles here</div>
                    <!-- /ko -->
                <p>

                <p>
                    <div class="muted">Chapter Synopsis:</div>
                    <div contentEditable="true" data-bind="htmlEditable: explainer"></div>
                </p>

                <span class="muted">Takes place on</span>
                <input type="date" class="input-medium" data-bind='value: _prettyDate, valueUpdate:     "afterkeydown"'/>
                <span class="muted">at</span>
                <input type="time" class="input-medium" data-bind='value: _prettyTime, valueUpdate: "afterkeydown"'/>
                <span class="muted">|</span>
                <a data-bind="click: $parent.deleteEvent">delete chapter</a>
            </div>
        <!-- /ko -->
    </div>
</script>

<!-- template: articles within events -->
<script type="text/html" id="event_article_template">
    <div class="article">
        <button type="button" class="close" data-bind='click: $parent.removeArticle' class="close">Ã—</button>
        <div class="article-star" data-bind="
            click: $parent.bumpContent,
            css: {
                'icon-star-empty': importance() <= 50,
                'icon-star': importance() > 50
            }
        "></div>
        <a class="article-title" target="_blank" data-bind="text: webTitle, attr: {href: _mDot}"></a>
        <span title="color: dark = serious, light = entertaining" data-bind="
            css: {
                'color-light': colour() <= 2,
                'color-dark': colour() > 2
            },
            click: $parent.setColour">*</span>
        <div class="article-meta">
            <span data-bind="text: _humanDate"></span>
            <span class="article-tone-picker">
                <label data-bind="css: {picked: tone() ==='overview'}">
                    <span class="pipe">|</span>
                    <span class="value">overview</span>
                    <input type="radio" name="tone" value="overview" data-bind="checked: tone" />
                </label>
                <label data-bind="css: {picked: tone() ==='background'}">
                    <span class="pipe">|</span>
                    <span class="value">background</span>
                    <input type="radio" name="tone" value="background" data-bind="checked: tone" />
                </label>
                <label data-bind="css: {picked: tone() ==='analysis'}">
                    <span class="pipe">|</span>
                    <span class="value">analysis</span>
                    <input type="radio" name="tone" value="analysis" data-bind="checked: tone" />
                </label>
                <label data-bind="css: {picked: tone() ==='reaction'}">
                    <span class="pipe">|</span>
                    <span class="value">reaction</span>
                    <input type="radio" name="tone" value="reaction" data-bind="checked: tone" />
                </label>
                <label data-bind="">
                    <span class="pipe">|</span>
                    <span class="value">none</span>
                    <input type="radio" name="tone" value="" data-bind="checked: tone" />
                </label>
            </span>
        </div>
    </div>
</script>

<script src="@routes.Assets.at("javascripts/storyEditor.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/vendor/humanized_time_span.js")" type="text/javascript"></script>


}
