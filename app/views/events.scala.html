@(identity: String, env: String)

@main("Story editor", env, isAuthed = true, identity) {

<div class="storify row-fluid">
  <div class="storify-articles span4">
    <form class="form-inline muted" onsubmit="return false">
        <h3>Articles</h3>
        <input type="text" placeholder="Search" 
            data-bind='event: {keyup: articles.articleSearch, mousedown: articles.articleSearch, afterpaste: articles.articleSearch}, value:
            articles.articleTerm, valueUpdate: ["afterkeydown", "afterpaste"]'/>
        <!--
        <select data-bind='
            value: articles.sectionTerm,
            options: sections,
            optionsText: "webTitle",
            optionsValue: "id",
            valueUpdate: "afterkeydown",
            optionsCaption: "Section",
            event: {change: articles.articleSearch}
            '></select> -->
        <label class="checkbox">
            <!--<input id="tone-news" type="checkbox" value="news" 
                data-bind="checked: articles.toneNews, event: {click: articles.articleSearch}"/>
                tone/news-->
        </label>
    </form>

    <div class="articles scrollable" data-bind='foreach: articles.articles'>
        <div class="article" draggable="true" data-bind="makeDraggable: true">
            <a class="article-title" target="_blank"
                data-bind="html: webTitle, attr: {href: _mDot}"></a>
            <div class="article-date"  data-bind="text: _humanDate"></div>
        </div>
    </div>
  </div>

  <div class="storify-events span8">
    <!-- ko if: !$root.stories.selected() -->
        <h3>Stories</h3>
        <button class="btn btn-mini create btn-success" data-bind="
            event: {click: stories.createStory}
        ">Start a Story</button>
        <div class="stories" data-bind="
            template: {name: 'story_closed_template', foreach: stories.stories}
        "></div>
        <div data-bind="text: stories.length() === 0 ? 'Loading stories...' : ''"></div>
    <!-- /ko -->

    <!-- ko with: $root.stories.selected() -->
        <div class="stories" data-bind="template: {name: 'story_open_template'}"></div>
    <!-- /ko -->

  </div>
</div>

<!-- template: story in closed state -->
<script type="text/html" id="story_closed_template">
    <div class="story-wrap">
        <div class="story-title" data-bind="
            text: title().length > 0 ? title : '(Un-titled story)',
            event: {click: $root.stories.setSelected}
        "></div>
    </div>
</script>

<!-- template: story in open state -->
<script type="text/html" id="story_open_template">
    <div class="story-wrap">
        <button class="btn btn-mini" data-bind="
            event: {click: $root.stories.clearSelected},
            disable: $root.pendingSave()
        ">&laquo; Back to Stories</button>

        <h3 class="story-title" contentEditable="true" data-bind="
            htmlValue: title
        "></h3>

        <p>
            <span data-bind="text: length() === 0 ? 'Has no events yet' : 'Has ' + length() 
                + ' event' + (length() > 1 ? 's' : '')"></span>
            <span data-bind="if: !_selected()">- <a data-bind="event: {click: createEvent}">add an event</a></span>
        </p>

        <p class="events" data-bind="template: {name: 'event_template', foreach: events}"></p>

        <p>
            <button class="btn btn-mini" data-bind="event: {click: $root.stories.deleteSelected}">Delete this story</button>
        </p>
    </div>
</script>

<!-- template: event -->
<script type="text/html" id="event_template">
        <div class="event" data-bind="makeDropabble: true, css: {well: $parent._selected() === $data}">

            <div class="event-header">
                <i data-bind="
                    click: bump,
                    css: {
                        'icon-star-empty': importance() <= 50,
                        'icon-star': importance() > 50
                    }
                "></i>
                <span class="event-title" data-bind="
                    text: title().length > 0 ? title : 'New Event',
                    event: {click: $parent.setSelected},
                "></span>
                <span class="count" data-bind="
                    text: content().length + ' article' + (content().length !== 1 ? 's' : '')
                "></span>
                <span class="event-date" data-bind="text: _humanDate"></span>
            </div>


            <!-- Show acticles is event is selected -->
            <div data-bind="if: $parent._selected() === $data">

                <div class="event-articles" data-bind="foreach: content">

                    <div class="article">
                        <button type="button" class="close" data-bind='click: $parent.removeArticle' class="close">Ã—</button>

                        <div class="article-star" data-bind="
                            click: $parent.bumpContent,
                            css: {
                                'icon-star-empty': importance() <= 50,
                                'icon-star': importance() > 50
                            }
                        "></div>
                        

                        <a class="article-title" target="_blank"
                            data-bind="text: webTitle, attr: {href: _mDot}"></a>

                        <span title="color: dark = serious, light = entertaining" data-bind="
                            css: {
                                'color-light': colour() <= 2,
                                'color-dark': colour() > 2
                            },
                            click: $parent.setColour">*</span>
                        <div class="article-date"  data-bind="text: _humanDate"></div>
                    </div>

                </div>
                
                <!-- ko if: content().length === 0 -->
                    <p class="alert">Drag articles here</p>
                <!-- /ko -->
                
                <div class="event-meta">
                    <div>
                        <span class="muted">Event date:</span> 
                        <span data-bind="text: _prettyDate"></span>
                        <span data-bind="text: _prettyTime"></span>                        
                    </div>
                </div>
    
                <button class="btn btn-danger btn-mini" type="submit" value="delete" data-bind="
                    click: $parent.deleteEvent
                ">Delete event</button>

                <form class="event-form" data-bind="if: false">
                  
                    <label>Title (what happend, is happening, or might happen?)</label>
                    <input type="text" placeholder="e.g. 'Helicopter crash"
                        data-bind='value: title, valueUpdate: "afterkeydown"' />

                    <label>When</label>
                    <input type="date"
                        data-bind='value: _prettyDate, valueUpdate: "afterkeydown"' />

                    <label>Time</label>
                    <input type="time"
                        data-bind='value: _prettyTime, valueUpdate: "afterkeydown"' />

                    <div>
                        <button class="btn btn-success btn-mini" type="submit" data-bind="enable: _isValid">Save event</button>

                        <button class="btn btn-danger btn-mini" type="submit" value="delete"
                            data-bind="click: $root.stories.deleteSelected"
                        >Delete event</button>
                    </div>
                </form>

        </div>
</script>

<script src="@routes.Assets.at("javascripts/storyEditor.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/vendor/humanized_time_span.js")" type="text/javascript"></script>


}
