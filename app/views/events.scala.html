@(config: String, env: String)

@main("Events editor", env, isAuthed = true) {

<p>
    <span class="alert">This is an experimental system to manage Events.</span>
</p>

<div class="storify row-fluid">

  <div class="storify-articles span6">

    <form class="form-inline">
        <input type="text" class="input-medium" placeholder="Article search" 
            data-bind='event: {keyup: articles.articleSearch}, value: articles.articleTerm, valueUpdate: "afterkeydown"'/>
        <label class="checkbox">
            <input id="tone-news" type="checkbox" value="news" 
                data-bind="checked: articles.toneNews, event: {click: articles.articleSearch}"/>
            tone/news
        </label>
    </form>

    <div class="articles" data-bind='foreach: articles.articles'>
        <div class="article" draggable="true" data-bind="makeDraggable: true">
            <a class="article-title" target="_blank"
                data-bind="html: webTitle, attr: {href: mDot}"></a>
            <div class="article-date"  data-bind="text: _humanDate"></div>
        </div>
    </div>
  </div>

  <div class="storify-events span6">
    <form class="form-inline">
        <input type="text" class="input-medium" placeholder="Event search"
            data-bind='event: {keyup: events.pruneTrees}, value: events.pruneTerm, valueUpdate: "afterkeydown"'/>
        <button class="btn btn-mini" data-bind="event: {click: events.createEvent}">Create a new event</button>
    </form>
    <div data-bind="text: events.length() === 0 ? 'Loading...' : ''"></div>
    <div class="events" data-bind="template: {name: 'event_template', foreach: events.trees}"></div>
  </div>

</div>

<script type="text/html" id="event_template">
  <!-- ko if: !_hidden() -->
    <div data-bind="css: {'event-wrapper': !$root.events.selected()}">

        <div class="event" 
            data-bind="makeDropabble: true, if: !$root.events.selected() || $root.events.selected() === $data">

            <div class="event-header">
                <i data-bind="
                    click: bump,
                    css: {
                        'icon-star-empty': importance() <= 50,
                        'icon-star': importance() > 50
                    }
                "></i>
                <span class="event-title" data-bind="
                    text: title().length > 0 ? title : 'New Event',
                    event: {click: $root.events.setSelected},
                    css: {'event-title-selected': $root.events.selected() === $data}
                "></span>
                <span class="event-date" data-bind="text: _humanDate"></span>
                <span class="event-article-count" 
                    data-bind="text: content().length + ' article' + (content().length !== 1 ? 's' : '')"></span>
            </div>

            <div data-bind="if: $root.events.selected() === $data">
                <div class="event-detail" data-bind="ifnot: _editing()">
                    <div class="event-articles" data-bind="foreach: content">
                        <!-- ko if: webTitle -->
                        <button type="button" class="close"
                            data-bind='click: $parent.removeArticle' class="close">Ã—</button>

                        <div class="article-star" data-bind="
                            click: $parent.bumpContent,
                            css: {
                                'icon-star-empty': importance() <= 50,
                                'icon-star': importance() > 50
                            }
                        "></div>

                        <div class="article">
                            <a class="article-title" target="_blank"
                                data-bind="text: webTitle, attr: {href: mDot}"></a>
                            <div class="article-date"  data-bind="text: _humanDate"></div>
                        </div>
                        <!-- /ko -->
                    </div>
                    <!-- ko if: content().length === 0 -->
                    <p class="alert">Drag articles here</p>
                    <!-- /ko -->
                    <dl>
                        <dt>Date</dt><dd data-bind="text: _prettyDate"></dd>
                        <dt>Time</dt><dd data-bind="text: _prettyTime"></dd>
                    </dl>
                     <button class="event-form-toggler btn btn-mini" data-bind="event: {click: toggleEditing}" href="javascript:void(0)">Edit Event</button>
                     <button class="btn btn-mini" data-bind="click: $root.events.createEventFollowOn">Create a "follow on" event</button>
                </div>

                <form class="event-form" 
                    data-bind="if: _editing(), submit: save">
                  
                    <label>What happened? (or what is happening?)</label>
                    <input type="text" placeholder="e.g. 'Helicopter crash"
                        data-bind='value: title, valueUpdate: "afterkeydown"' />
                        
                    <label>When</label>
                    <input type="date"
                        data-bind='value: _prettyDate, valueUpdate: "afterkeydown"' />

                    <label>Time</label>
                    <input type="time"
                        data-bind='value: _prettyTime, valueUpdate: "afterkeydown"' />

                    <label>Which previous event does this follow?</label>
                    <select data-bind='
                        value: _parentId, 
                        options: $root.events.previous(),
                        optionsText: "title",
                        optionsValue: "id",
                        optionsCaption: "(none)"
                    '>
                    </select>

                    <div>
                        <button class="btn btn-success btn-mini" type="submit" data-bind="enable: _isValid">Save event</button>
                        <button class="btn btn-mini" type="submit" value="cancel"
                            data-bind="click: $root.events.cancelEditing" 
                        >Cancel</button>
                        <button class="btn btn-danger btn-mini" type="submit" value="delete"
                            data-bind="click: $root.events.deleteEvent, visible: !_tentative()"
                        >Delete event</button>
                    </div>
                </form>

            </div>
        </div>
        <div data-bind="
            css: {
                'event-children': !$root.events.selected()
            },
            template: {
                name: 'event_template',
                foreach: _children,
            }
        ">
        </div>
    </div>
  <!-- /ko -->
</script>

<script src="@routes.Assets.at("javascripts/eventsEditor.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/vendor/humanized_time_span.js")" type="text/javascript"></script>


}
